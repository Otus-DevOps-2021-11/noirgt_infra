# noirgt_infra
noirgt Infra repository

# Задание 1:
> Предложить вариант решения для подключения из консоли при помощи
> команды вида ssh someinternalhost из локальной консоли рабочего
> устройства, чтобы подключение выполнялось по алиасу
> someinternalhost и внести его в README.md в вашем репозитории

Для выполнения этого задания я использовал привычную команду **ssh**, но с флагом **-J** для прыжка на второй хост через первый:
```
ssh -J 51.250.28.70 10.128.0.6
```
И для удобства подключения через алис я внёс в файл **~/.ssh/config** следующий блок конфигурации:
```
Host someinternalhost
        HostName 10.128.0.6
        ProxyJump noble@51.250.28.70:22
        User noble
```
# Задание 2:
> Описать конфигурацию и данные для подключения Pritunl

Данное задание выполнил для удобства на CentOS - думаю, это не критично. Ниже данные для подключения:
```
bastion_IP = 51.250.28.70
someinternalhost_IP = 10.128.0.6
```
# ДЗ "Деплой тестового приложения":
# Задание 1:
Данные для подключения к облачному приложению:
```
testapp_IP = 51.250.5.97
testapp_port = 9292
```

# ДЗ "Модели управления инфраструктурой. Подготовка образов с помощью Packer":
В рамках данного задания было сделано следующее:
- Дополнены скрипты для деплоя приложения под Packer;
- Создан сценарий для шаблона VM с необходимым софтом для приложения - **reddit-base**;
- Создан сценарий для bake-шаблона VM с необходимым софтом и **запущенным приложением** - **reddit-full**;
- Переопределены переменные с закрытой информацией и индивидуальными параметрами VM в отдельном `.json`-файле.

# ДЗ "Практика IaC с использованием Terraform":
# Задание 1:
- Определены необходимые INPUT-переменные, в том числе и переменная для приватного ключа, использующегося в определении подключения для
провижинеров (connection);
- Отформатирован конфигурационный файл при помощи `terraform fmt`;
- Создан файл `terraform.tfvars.example`, содержащий образцы INPUT-переменных.
# Задание с ⭐:
В рамках данного задания был создан балансировщик, отправляющий трафик на два инстанса. Создание необходимого числа ресурсов
с VM осуществляется через цикл `Count`. Добавление необходимого числа таргетов в таргет-группы для балансировщика 
осуществляется через цикл `for`. Ниже блок используемый для этого блок кода:
```hcl
  dynamic "target" {
    for_each = [
      for one_app in yandex_compute_instance.app : {
      subnet_id = one_app.network_interface.0.subnet_id
      address   = one_app.network_interface.0.ip_address
      }]

    content {
      subnet_id = target.value.subnet_id
      address   = target.value.address
    }
  }
```

# ДЗ: "Принципы организации инфраструктурного кода и работа над инфраструктурой в команде на примере Terraform":
# Задание 1:
- Созданы отдельные проекты для **stage** и **prod**;
- Дополнительно параметризированы параметры для backend S3;
- Отформатирована конфигурация и залита в Github.
# Задание с ⭐:
- Настроено хранение стейта в backend S3 от Yandex для совместной работы;
- Проверена работа блокировок при совместной работе;
- Добавлен отдельный модуль **reddit** с **provisioners** для деплоя приложения на application.

# ДЗ: "Управление конфигурацией. Знакомство с Ansible":
 # Задание 1:
 - Разобраны типовые Ad-Hoc команды;
 - Написан базовый плейбук;
 - Выполнена работа с различными типами Inventory-файлов;
 # Задание с ⭐:
 > В рамках текущего задания требовалось создать скрипт, создающий динамический Inventory-файл с
 > JSON-структурой. Мною был написан очень простенький Python-скрипт, который получает список
 > всех инстансов через Yandex CLI. На основе имени инстанса определяет группу, к которой он относится.
 > Например, для `reddit-app` и `reddit-db` в логике скрипта группа формируется из окончания имени -
 > `app` и `db` соответственно. 
 > Скрипт создаёт словарь с ключами в виде групп и значениями в виде массивов с элементами хостов,
 > конвертирует его в JSON и print-ом отдаёт вывод.
 > Работу скрипта проверил - работает. К сожалению, автотест по этому заданию не прошёл, так как не имеет
 > сервисного доступа к моему Yandex Cloud. В ansible.cfg вернул путь к статическому Inventory-файлу.

# ДЗ: "Деплой и управление конфигурацией с Ansible":
# Задание 1:
- Написан общий плейбук для инстансов и деплоя приложения;
- Выполнен запуск плейбука по группам хостов и тегам;
- Написан один плейбук на несколько сценариев;
- Созданы несколько плейбуков для одного полного сценария. Использован **import**;
- Написаны плейбуки для подготовки образов через **packer** в блоке `provisioners`.

# ДЗ: "Ansible: работа с ролями и окружениями":
# Задание 1:
- Перенесены созданные ранее плейбуки в отдельные роли;
- Разделены окружения на **prod** и **stage**;
- Использована community-роль **nginx**, взятая с **Ansible Galaxy**;
- Зашифрованы пароли в плейбуках при помощи **Ansible Vault**.
# Задание с ⭐:
- Настроен динамический inventory-файл отдельно для **prod** и **stage** окружений.
# Дополнительная оптимизация от себя:
- Выполнен запуск плейбука после развёртки VM из Terraform (нулевой ресурс).
